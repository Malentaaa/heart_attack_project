<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Heart Risk — CSV Pred</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1226;
      --card: #161a33;
      --accent: #7b5cff;
      --accent2: #4cc9f0;
      --text: #e7e9ff;
      --muted: #bfc5ff99;
      --ok: #22c55e;
      --bad: #ef4444;
    }
    html, body { height:100%; }
    body {
      margin:0; background: radial-gradient(1200px 600px at 20% -10%, #1f2350, transparent), var(--bg);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      display:flex; align-items:flex-start; justify-content:center; padding:40px 16px;
    }
    .wrap { width: min(980px, 100%); }
    h1 { margin:0 0 24px; font-weight:700; letter-spacing:.2px; }
    .card {
      background: linear-gradient(180deg, #1b1f41, #121530);
      border:1px solid #262b58; border-radius:18px; padding:24px; box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .dropzone {
      border:2px dashed #5157a6; border-radius:12px; padding:22px; text-align:center;
      transition:.2s transform, .2s border-color, .2s background;
      background: #12163a;
    }
    .dropzone.drag { transform: scale(0.99); border-color: var(--accent2); background:#0f1534; }
    .file-input { display:block; margin:10px auto 0; }
    .btn {
      display:block; width:100%; margin-top:18px; padding:14px 18px; font-size:16px; font-weight:600;
      border:0; border-radius:14px; cursor:pointer; color:white;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 8px 24px rgba(123, 92, 255, .25);
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .hint { color:var(--muted); font-size:13px; margin-top:8px; }
    .summary { margin-top:18px; padding:16px; border-radius:12px; background:#11351f; border:1px solid #205b32; display:none; }
    .summary .kpi { display:flex; gap:18px; margin-top:6px; }
    .kpi span { background:#0e1c12; border:1px solid #1f3d28; padding:8px 10px; border-radius:10px; }
    .list { margin-top:14px; background:#121530; border:1px solid #2a2f61; border-radius:14px; max-height:360px; overflow:auto; display:none; }
    .row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #20255d; }
    .row:last-child { border-bottom:0; }
    .badge { display:inline-flex; align-items:center; gap:8px; font-weight:600; }
    .dot { width:10px; height:10px; border-radius:999px; }
    .dot.ok { background: var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.12); }
    .dot.bad { background: var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.12); }
    .proba { color:#b3b9ff; font-variant-numeric: tabular-nums; }
    footer { margin-top:18px; color:var(--muted); font-size:12px; }
    a { color:#9eb5ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Загрузка CSV и предсказания риска</h1>
    <div class="card">
      <div id="dz" class="dropzone">
        <div>Перетащите сюда CSV или выберите файл</div>
        <input id="file" class="file-input" type="file" accept=".csv" />
        <div class="hint">Файл должен содержать те же столбцы, что и при обучении модели.</div>
      </div>
      <button id="run" class="btn">Сделать предсказание</button>

      <div id="summary" class="summary">
        <div>Предсказания готовы!</div>
        <div class="kpi">
          <span><b>Всего:</b> <span id="k-total">0</span></span>
          <span><b>Класс 1:</b> <span id="k-pos">0</span></span>
          <span><b>Класс 0:</b> <span id="k-neg">0</span></span>
        </div>
      </div>

      <div id="list" class="list"></div>
      <footer>API: <a href="/docs" target="_blank">Swagger</a> • <a href="/health" target="_blank">/health</a></footer>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const runBtn = document.getElementById('run');
    const dz = document.getElementById('dz');
    const summary = document.getElementById('summary');
    const list = document.getElementById('list');
    const kTotal = document.getElementById('k-total');
    const kPos = document.getElementById('k-pos');
    const kNeg = document.getElementById('k-neg');

    // drag&drop эффекты
    ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
    dz.addEventListener('drop', e => { fileInput.files = e.dataTransfer.files; });

    runBtn.addEventListener('click', async () => {
      if (!fileInput.files[0]) { alert('Выберите CSV файл'); return; }
      runBtn.disabled = true;

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);

      try {
        const res = await fetch('/api/predict_csv', { method: 'POST', body: fd });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();

        // показать сводку
        kTotal.textContent = data.total;
        kPos.textContent = data.positive;
        kNeg.textContent = data.negative;
        summary.style.display = 'block';

        // список результатов
        list.innerHTML = '';
        data.items.forEach(row => {
          const el = document.createElement('div');
          el.className = 'row';
          const ok = row.label === 1;
          el.innerHTML = `
            <div class="badge"><span>Пациент ${row.row_id}</span></div>
            <div class="badge">
              <span class="dot ${ok ? 'bad' : 'ok'}"></span>
              <span>${ok ? 'РИСК ЕСТЬ' : 'РИСКА НЕТ'}</span>
            </div>
            <div class="proba">${(row.proba*100).toFixed(1)}%</div>
          `;
          list.appendChild(el);
        });
        list.style.display = 'block';
      } catch (e) {
        alert('Ошибка: ' + e.message);
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
